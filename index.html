<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeri Kenangan Kita ‚ù§Ô∏è</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fff1f8 0%, #fce7f3 50%, #fef3c7 100%);
            min-height: 100vh;
            color: #4c1d3b;
        }
        
        .title-font {
            font-family: 'Playfair Display', serif;
        }
        
        .cursive-font {
            font-family: 'Dancing Script', cursive;
        }
        
        .photo-card {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(236, 72, 153, 0.15);
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .photo-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ec4899, #f472b6, #fbb6ce);
            border-radius: 24px 24px 0 0;
        }
        
        .photo-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 25px 50px rgba(236, 72, 153, 0.25);
        }
        
        .love-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .love-btn.loved {
            color: #ec4899;
            filter: drop-shadow(0 0 12px rgba(236, 72, 153, 0.6));
            animation: pulse 0.5s ease;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .love-btn:hover {
            transform: scale(1.3);
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
        }
        
        /* Warna kategori */
        .cat-cb { 
            background: linear-gradient(135deg, #fef3c7, #fde68a); 
            color: #92400e;
            border: 2px solid #fbbf24;
        }
        
        .cat-ld { 
            background: linear-gradient(135deg, #d1fae5, #a7f3d0); 
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .cat-nb { 
            background: linear-gradient(135deg, #dbeafe, #93c5fd); 
            color: #1e40af;
            border: 2px solid #3b82f6;
        }
        
        .cat-cb-active { 
            background: linear-gradient(135deg, #f59e0b, #fbbf24) !important; 
            color: white !important;
            border-color: #f59e0b !important;
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }
        
        .cat-ld-active { 
            background: linear-gradient(135deg, #10b981, #34d399) !important; 
            color: white !important;
            border-color: #10b981 !important;
            transform: scale(1.05);
         
        }
        
        .cat-nb-active { 
            background: linear-gradient(135deg, #3b82f6, #60a5fa) !important; 
            color: white !important;
            border-color: #3b82f6 !important;
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        
        .filter-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
       
        .type-btn {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .type-btn.active {
            background: linear-gradient(135deg, #ec4899, #f472b6) !important;
            color: white !important;
            border-color: #ec4899 !important;
            box-shadow: 0 8px 20px rgba(236, 72, 153, 0.25);
        }
        
        .floating-btn {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .heart-beat {
            animation: heartbeat 1.5s ease-in-out infinite;
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #ec4899, #f472b6, #fbb6ce, #fef3c7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card-image {
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .photo-card:hover .card-image {
            transform: scale(1.1);
        }
        
        /* Responsive grid adjustments */
        @media (max-width: 640px) {
            .photo-card {
                border-radius: 20px;
            }
        }
        
        /* Loading animation */
        .loading-dots {
            display: flex;
            gap: 8px;
        }
        
        .loading-dots span {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ec4899, #f472b6);
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Floating hearts background -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div class="absolute top-1/4 left-10 text-4xl text-pink-200 opacity-20 animate-pulse">‚ù§Ô∏è</div>
        <div class="absolute top-1/3 right-20 text-3xl text-rose-200 opacity-30 animate-pulse">üíñ</div>
        <div class="absolute bottom-1/4 left-20 text-5xl text-pink-300 opacity-25 animate-pulse">üíï</div>
        <div class="absolute top-20 right-1/4 text-6xl text-rose-300 opacity-20 animate-pulse">‚ú®</div>
    </div>

    <header class="pt-8 sm:pt-12 pb-12 sm:pb-16 relative z-10">
        <div class="max-w-6xl mx-auto px-4 sm:px-6">
            <div class="text-center bg-white/90 backdrop-blur-lg rounded-3xl p-6 sm:p-10 shadow-2xl border border-pink-100 relative overflow-hidden">
                <!-- Decorative elements -->
                <div class="absolute -top-6 -left-6 w-24 h-24 bg-pink-200 rounded-full opacity-20"></div>
                <div class="absolute -bottom-8 -right-8 w-32 h-32 bg-rose-200 rounded-full opacity-20"></div>
                
                <div class="relative z-10">
                    <h1 class="title-font text-4xl sm:text-6xl md:text-7xl font-bold gradient-text mb-4 sm:mb-6">
                        Kenangan Kita
                    </h1>
                    <p class="cursive-font text-2xl sm:text-3xl text-pink-700 mb-6">Momen berharga yang tak akan pernah terlupakan ‚ú®</p>
                    
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-6 mt-8">
                        <div class="bg-white/80 backdrop-blur-sm px-6 py-4 rounded-2xl text-base sm:text-lg font-medium border-2 border-pink-200 shadow-lg">
                            <i class="fas fa-heart text-pink-600 mr-3 heart-beat"></i>
                            <span id="totalLikes" class="text-pink-700 font-bold">0</span> Love ‚Ä¢ 
                            <span id="totalPhotos" class="text-pink-700 font-bold">0</span> Kenangan
                        </div>
                     
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 mb-12 relative z-10">
        <!-- Filter Kategori -->
        <div class="flex flex-wrap gap-3 sm:gap-4 justify-center mb-8">
            <button onclick="filterPhotos('all', this)" 
                    class="filter-btn active px-6 sm:px-8 py-3 sm:py-4 rounded-full font-semibold shadow-lg transition-all bg-gradient-to-r from-pink-500 to-rose-500 text-white text-sm sm:text-base">
                <i class="fas fa-star mr-2"></i> Semua Kenangan
            </button>
            <button onclick="filterPhotos('cb', this)" 
                    class="filter-btn px-6 sm:px-8 py-3 sm:py-4 rounded-full font-semibold shadow-md transition-all bg-white text-amber-800 border-2 border-amber-200 text-sm sm:text-base hover:shadow-lg">
                <i class="fas fa-users mr-2"></i> Character Building
            </button>
            <button onclick="filterPhotos('ld', this)" 
                    class="filter-btn px-6 sm:px-8 py-3 sm:py-4 rounded-full font-semibold shadow-md transition-all bg-white text-emerald-800 border-2 border-emerald-200 text-sm sm:text-base hover:shadow-lg">
                <i class="fas fa-flag mr-2"></i> Leadership Development
            </button>
            <button onclick="filterPhotos('nb', this)" 
                    class="filter-btn px-6 sm:px-8 py-3 sm:py-4 rounded-full font-semibold shadow-md transition-all bg-white text-blue-800 border-2 border-blue-200 text-sm sm:text-base hover:shadow-lg">
                <i class="fas fa-landmark mr-2"></i> National Building
            </button>
        </div>
        
        <!-- Filter Tipe & Sort -->
        <div class="flex flex-wrap gap-3 justify-center">
            <button onclick="filterByType('all', this)" 
                    class="type-btn active px-5 py-2.5 rounded-xl font-medium transition-all bg-pink-100 text-pink-800 hover:bg-pink-200 text-sm sm:text-base">
                <i class="fas fa-layer-group mr-2"></i> Semua Media
            </button>
            <button onclick="filterByType('image', this)" 
                    class="type-btn px-5 py-2.5 rounded-xl font-medium transition-all bg-white text-slate-700 border-2 border-slate-300 hover:bg-slate-50 text-sm sm:text-base">
                <i class="fas fa-camera mr-2"></i> Foto
            </button>
            <button onclick="filterByType('video', this)" 
                    class="type-btn px-5 py-2.5 rounded-xl font-medium transition-all bg-white text-slate-700 border-2 border-slate-300 hover:bg-slate-50 text-sm sm:text-base">
                <i class="fas fa-video mr-2"></i> Video
            </button>
            <button onclick="sortByLikes()" 
                    class="px-5 py-2.5 rounded-xl font-medium transition-all bg-gradient-to-r from-rose-500 to-pink-500 text-white shadow-md hover:shadow-lg transform hover:scale-105 text-sm sm:text-base">
                <i class="fas fa-fire mr-2"></i> Paling Disukai
            </button>
        </div>
    </div>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 pb-24 sm:pb-32 relative z-10">
        <div id="loadingIndicator" class="text-center py-20 sm:py-32">
            <div class="text-5xl sm:text-6xl text-pink-500 mb-6 animate-pulse">
                <i class="fas fa-heart fa-beat"></i>
            </div>
            <div class="loading-dots justify-center mb-4">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <p class="text-pink-700 text-lg sm:text-xl font-medium">Memuat kenangan indah...</p>
        </div>
        
        <div id="gallery" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8"></div>
        
        <div id="emptyState" class="hidden text-center py-20 sm:py-32">
            <div class="text-8xl sm:text-9xl text-pink-300 mb-6 sm:mb-8 animate-pulse">üíï</div>
            <h3 class="title-font text-3xl sm:text-4xl font-bold text-pink-900 mb-4 sm:mb-6">Belum Ada Kenangan</h3>
            <p class="text-pink-700 text-base sm:text-lg mb-8 sm:mb-10">Mari ciptakan momen pertama yang tak terlupakan</p>
            <button onclick="openUploadModal()" 
                    class="bg-gradient-to-r from-pink-500 to-rose-500 text-white px-8 sm:px-10 py-4 sm:py-5 rounded-full font-bold text-base sm:text-lg shadow-xl hover:shadow-2xl transition transform hover:scale-105">
                <i class="fas fa-plus mr-2 sm:mr-3"></i> Tambah Kenangan Pertama
            </button>
        </div>
    </main>

    <!-- Floating Button -->
    <div class="fixed bottom-6 right-6 z-30">
        <button onclick="openUploadModal()" 
                class="floating-btn bg-gradient-to-r from-pink-600 to-rose-600 text-white p-4 sm:p-6 rounded-full shadow-2xl hover:shadow-pink-500/50 transition transform hover:scale-110">
            <i class="fas fa-plus text-2xl sm:text-3xl"></i>
        </button>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white rounded-3xl max-w-4xl w-full max-h-[95vh] overflow-y-auto shadow-2xl border border-pink-100" onclick="event.stopPropagation()">
            <div class="relative">
                <button onclick="closeModal()" class="absolute top-4 sm:top-6 right-4 sm:right-6 bg-white/90 rounded-full p-3 sm:p-4 shadow-lg hover:bg-white z-10 transition">
                    <i class="fas fa-times text-xl sm:text-2xl text-pink-700"></i>
                </button>
                <div id="modalMediaContainer" class="bg-gradient-to-b from-pink-50 to-rose-50 min-h-[300px] sm:min-h-[400px] flex items-center justify-center"></div>
                <div class="p-6 sm:p-10">
                    <div class="flex flex-col sm:flex-row justify-between items-start gap-4 sm:gap-0 mb-6 sm:mb-8">
                        <div class="flex-1">
                            <h3 id="modalTitle" class="title-font text-2xl sm:text-4xl font-bold text-pink-900 mb-2 sm:mb-3"></h3>
                            <p id="modalDate" class="text-pink-700 flex items-center text-base sm:text-lg">
                                <i class="far fa-calendar-alt mr-2 sm:mr-3"></i><span id="dateText"></span>
                            </p>
                        </div>
                        <button id="modalLoveBtn" onclick="toggleLove(currentPhotoId)" class="love-btn text-4xl sm:text-5xl">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-6 mb-6 sm:mb-8">
                        <span id="modalCategory" class="px-4 sm:px-6 py-2 sm:py-3 rounded-full text-sm sm:text-base font-bold inline-block w-fit"></span>
                        <span id="modalLikes" class="flex items-center text-pink-700 font-bold text-lg sm:text-xl">
                            <i class="fas fa-heart mr-2 sm:mr-3"></i><span id="likeCount" class="mr-1">0</span>  Love
                        </span>
                    </div>
                    
                    <p id="modalDescription" class="text-pink-800 text-base sm:text-lg leading-relaxed mb-8 sm:mb-10"></p>
                    
                    <div class="flex gap-4">
                        <button onclick="deletePhoto()" class="bg-red-50 text-red-700 px-6 sm:px-8 py-3 sm:py-4 rounded-xl font-bold hover:bg-red-100 transition border-2 border-red-200">
                            <i class="fas fa-trash mr-2"></i> Hapus Kenangan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white rounded-3xl max-w-lg w-full shadow-2xl border border-pink-100 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6 sm:p-10">
                <div class="text-center mb-8 sm:mb-10">
                    <div class="text-5xl sm:text-6xl mb-4 gradient-text">üíñ</div>
                    <h3 class="title-font text-2xl sm:text-4xl font-bold text-pink-900">Tambah Kenangan Baru</h3>
                    <p class="text-pink-700 mt-2 sm:mt-3 text-base sm:text-lg">Abadikan momen spesialmu selamanya</p>
                </div>
                
                <form id="uploadForm" class="space-y-4 sm:space-y-6">
                    <div>
                        <label class="block text-pink-900 font-semibold mb-2 text-sm sm:text-base">Judul Kenangan</label>
                        <input type="text" id="photoTitle" required class="w-full px-4 sm:px-5 py-3 sm:py-4 border-2 border-pink-200 rounded-xl focus:ring-4 focus:ring-pink-300 focus:border-pink-500 outline-none transition text-sm sm:text-base">
                    </div>
                    
                    <div>
                        <label class="block text-pink-900 font-semibold mb-2 text-sm sm:text-base">Tanggal</label>
                        <input type="date" id="photoDate" required class="w-full px-4 sm:px-5 py-3 sm:py-4 border-2 border-pink-200 rounded-xl focus:ring-4 focus:ring-pink-300 focus:border-pink-500 outline-none text-sm sm:text-base">
                    </div>
                    
                    <div>
                        <label class="block text-pink-900 font-semibold mb-2 text-sm sm:text-base">Kategori</label>
                        <select id="photoCategory" class="w-full px-4 sm:px-5 py-3 sm:py-4 border-2 border-pink-200 rounded-xl focus:ring-4 focus:ring-pink-300 focus:border-pink-500 outline-none text-sm sm:text-base">
                            <option value="cb">Character Building</option>
                            <option value="ld">Leadership Development</option>
                            <option value="nb">National Building</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-pink-900 font-semibold mb-2 text-sm sm:text-base">Deskripsi (opsional)</label>
                        <textarea id="photoDescription" rows="3" class="w-full px-4 sm:px-5 py-3 sm:py-4 border-2 border-pink-200 rounded-xl focus:ring-4 focus:ring-pink-300 focus:border-pink-500 outline-none text-sm sm:text-base"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-pink-900 font-semibold mb-2 text-sm sm:text-base">Upload Foto / Video</label>
                        <div class="border-4 border-dashed border-pink-300 rounded-2xl p-6 sm:p-10 text-center hover:border-pink-500 transition cursor-pointer" onclick="document.getElementById('photoFile').click()">
                            <i class="fas fa-cloud-upload-alt text-4xl sm:text-5xl text-pink-400 mb-3 sm:mb-4"></i>
                            <p class="text-pink-800 font-medium text-base sm:text-lg">Klik untuk memilih file</p>
                            <p class="text-pink-600 text-xs sm:text-sm mt-2">JPG, PNG, MP4 ‚Ä¢ Maks 10MB</p>
                        </div>
                        <input type="file" id="photoFile" accept="image/*,video/*" required class="hidden" onchange="previewMedia(event)">
                        
                        <div id="uploadProgress" class="hidden mt-4 sm:mt-6">
                            <div class="flex justify-between text-xs sm:text-sm mb-2 sm:mb-3">
                                <span class="text-pink-800">Mengunggah...</span>
                                <span id="progressPercent" class="text-pink-700">0%</span>
                            </div>
                            <div class="w-full bg-pink-200 rounded-full h-2 sm:h-3">
                                <div id="progressBar" class="h-2 sm:h-3 rounded-full bg-gradient-to-r from-pink-500 to-rose-500 transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div id="mediaPreview" class="mt-4 sm:mt-6 rounded-2xl overflow-hidden border-4 border-pink-200 bg-pink-50">
                            <p class="text-pink-400 text-center py-12 sm:py-16 text-base sm:text-lg">Preview akan muncul di sini ‚ô°</p>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 sm:gap-6 pt-4 sm:pt-6">
                        <button type="button" id="submitBtn" class="flex-1 bg-gradient-to-r from-pink-500 to-rose-500 text-white py-4 sm:py-5 rounded-xl font-bold text-base sm:text-lg shadow-lg hover:shadow-xl transition transform hover:scale-105">
                            Simpan Kenangan
                        </button>
                        <button type="button" onclick="closeUploadModal()" class="flex-1 bg-gray-200 text-gray-800 py-4 sm:py-5 rounded-xl font-bold text-base sm:text-lg hover:bg-gray-300 transition">
                            Batal
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed bottom-20 sm:bottom-24 left-1/2 -translate-x-1/2 bg-gradient-to-r from-pink-600 to-rose-600 text-white px-6 sm:px-8 py-3 sm:py-4 rounded-full shadow-2xl z-50 transition-all max-w-[90vw]">
        <span id="toastMessage" class="font-medium text-sm sm:text-lg">Berhasil!</span>
    </div>

<script>
    let photos = [];
    let currentFilter = 'all';
    let currentTypeFilter = 'all';
    let currentPhotoId = null;
    let lovedPhotos = new Set();

    const supabaseUrl = 'https://cgobihlfddgyhrlfmcew.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnb2JpaGxmZGRneWhybGZtY2V3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMDM1MDIsImV4cCI6MjA4MjY3OTUwMn0.OiiCP11equ1AjyG5nayqTmfaJH3rg28UiaqG9QV1-Hs';

    const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

    const cloudName = 'dxcconkoi';
    const uploadPreset = 'galerikenangan';

    function showToast(message) {
        const toast = document.getElementById('toast');
        document.getElementById('toastMessage').textContent = message;
        toast.classList.remove('hidden', 'opacity-0');
        toast.classList.add('opacity-100');
        setTimeout(() => {
            toast.classList.add('opacity-0');
            setTimeout(() => toast.classList.add('hidden'), 300);
        }, 3000);
    }

    async function uploadToCloudinary(file) {
        return new Promise((resolve, reject) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', uploadPreset);

            document.getElementById('uploadProgress').classList.remove('hidden');

            const xhr = new XMLHttpRequest();
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    document.getElementById('progressBar').style.width = percent + '%';
                    document.getElementById('progressPercent').textContent = percent + '%';
                }
            });

            xhr.onload = () => {
                document.getElementById('uploadProgress').classList.add('hidden');
                if (xhr.status === 200) {
                    const res = JSON.parse(xhr.responseText);
                    resolve(res.secure_url);
                } else reject(new Error('Upload gagal'));
            };

            xhr.onerror = () => {
                document.getElementById('uploadProgress').classList.add('hidden');
                reject(new Error('Network error'));
            };

            xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`);
            xhr.send(formData);
        });
    }

    async function loadFromSupabase() {
        try {
            const { data, error } = await supabaseClient
                .from('memories')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;

            photos = data ? data.map(item => ({
                id: item.id,
                title: item.title || 'Tanpa Judul',
                date: item.date || new Date().toLocaleDateString('id-ID'),
                category: item.category || 'cb',
                description: item.description || '',
                image: item.media_url,
                type: item.media_type || 'image',
                likes: item.likes || 0,
                timestamp: item.created_at
            })) : [];

            const saved = localStorage.getItem('lovedPhotos');
            lovedPhotos = saved ? new Set(JSON.parse(saved)) : new Set();

            return true;
        } catch (err) {
            console.error(err);
            showToast('Gagal memuat data');
            return false;
        }
    }

    function updateStatistics() {
        const totalLikes = photos.reduce((sum, p) => sum + (p.likes || 0), 0);
        document.getElementById('totalLikes').textContent = totalLikes;
        document.getElementById('totalPhotos').textContent = photos.length;
    }

    async function initApp() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('photoDate').value = today;

        const loaded = await loadFromSupabase();
        if (loaded) {
            renderGallery();
            updateStatistics();
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById(photos.length > 0 ? 'gallery' : 'emptyState').classList.remove('hidden');
            document.getElementById(photos.length > 0 ? 'emptyState' : 'gallery').classList.add('hidden');
        }

        document.getElementById('submitBtn').addEventListener('click', addPhoto);
        document.getElementById('photoModal').addEventListener('click', (e) => e.target === e.currentTarget && closeModal());
        document.getElementById('uploadModal').addEventListener('click', (e) => e.target === e.currentTarget && closeUploadModal());
    }

    function filterPhotos(category, button) {
        currentFilter = category;
        renderGallery();

        // Reset semua tombol kategori
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active', 'cat-cb-active', 'cat-ld-active', 'cat-nb-active', 'from-pink-500', 'to-rose-500', 'text-white');
            btn.classList.remove('bg-gradient-to-r');
            btn.classList.add('bg-white');
            if (btn.textContent.includes('Character')) btn.classList.add('text-amber-800', 'border-amber-200');
            if (btn.textContent.includes('Leadership')) btn.classList.add('text-emerald-800', 'border-emerald-200');
            if (btn.textContent.includes('National')) btn.classList.add('text-blue-800', 'border-blue-200');
        });

        // Aktifkan tombol yang diklik
        if (category === 'all') {
            button.classList.remove('bg-white');
            button.classList.add('bg-gradient-to-r', 'from-pink-500', 'to-rose-500', 'text-white', 'active');
        } else if (category === 'cb') {
            button.classList.add('cat-cb-active', 'active');
            button.classList.remove('bg-white', 'text-amber-800', 'border-amber-200');
        } else if (category === 'ld') {
            button.classList.add('cat-ld-active', 'active');
            button.classList.remove('bg-white', 'text-emerald-800', 'border-emerald-200');
        } else if (category === 'nb') {
            button.classList.add('cat-nb-active', 'active');
            button.classList.remove('bg-white', 'text-blue-800', 'border-blue-200');
        }
    }

    function filterByType(type, button) {
        currentTypeFilter = type;
        renderGallery();

        // Reset semua type button
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
        // Aktifkan yang dipilih
        button.classList.add('active');
    }

    function renderGallery() {
        let filtered = currentFilter === 'all' ? photos : photos.filter(p => p.category === currentFilter);
        if (currentTypeFilter !== 'all') filtered = filtered.filter(p => p.type === currentTypeFilter);

        const gallery = document.getElementById('gallery');
        if (filtered.length === 0) {
            gallery.classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            return;
        }

        gallery.classList.remove('hidden');
        document.getElementById('emptyState').classList.add('hidden');

        gallery.innerHTML = filtered.map(photo => {
            const isLoved = lovedPhotos.has(photo.id);
            const catClass = photo.category === 'cb' ? 'cat-cb' : photo.category === 'ld' ? 'cat-ld' : 'cat-nb';
            const categoryName = { 
                cb: 'Character Building', 
                ld: 'Leadership Development', 
                nb: 'National Building' 
            }[photo.category];
            
            const catIcon = {
                cb: '<i class="fas fa-users mr-2"></i>',
                ld: '<i class="fas fa-flag mr-2"></i>',
                nb: '<i class="fas fa-landmark mr-2"></i>'
            }[photo.category];

            return `
                <div class="photo-card">
                    <div class="relative overflow-hidden aspect-video rounded-t-2xl" onclick="openModal(${photo.id})">
                        ${photo.type === 'video' ? `
                            <video src="${photo.image}" class="w-full h-full object-cover card-image" muted loop playsinline></video>
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                            <div class="absolute bottom-4 left-4 text-white flex items-center text-base font-medium">
                                <i class="fas fa-play-circle mr-2 text-xl"></i> Video
                            </div>
                        ` : `
                            <img src="${photo.image}" alt="${photo.title}" class="w-full h-full object-cover card-image">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                        `}
                        <div class="absolute top-4 right-4 px-4 py-2 rounded-full text-xs font-bold ${catClass}">
                            ${catIcon}${categoryName}
                        </div>
                        <div class="absolute bottom-4 right-4 flex items-center gap-2">
                            <button onclick="event.stopPropagation(); toggleLove(${photo.id})" class="love-btn text-2xl sm:text-3xl drop-shadow-lg ${isLoved ? 'loved' : 'text-white'}">
                                <i class="${isLoved ? 'fas' : 'far'} fa-heart"></i>
                            </button>
                            <span class="text-white font-bold text-lg drop-shadow">${photo.likes || 0}</span>
                        </div>
                    </div>
                    <div class="p-5 sm:p-6 flex flex-col flex-grow">
                        <h3 class="title-font text-xl font-bold text-pink-900 mb-2 line-clamp-2" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${photo.title}</h3>
                        <p class="text-pink-700 flex items-center mb-3 text-sm">
                            <i class="far fa-calendar-alt mr-2"></i>${photo.date}
                        </p>
                        <p class="text-pink-800 line-clamp-3 mb-4 flex-grow text-sm" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">${photo.description || 'Tanpa deskripsi'}</p>
                        <button onclick="openModal(${photo.id})" class="text-pink-600 font-bold hover:text-pink-700 flex items-center text-sm sm:text-base w-fit">
                            Lihat Detail <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function sortByLikes() {
        photos.sort((a, b) => (b.likes || 0) - (a.likes || 0));
        renderGallery();
        showToast('Diurutkan berdasarkan love terbanyak ‚ù§Ô∏è');
    }

    async function toggleLove(photoId) {
        if (event) event.stopPropagation();
        photoId = parseInt(photoId);
        if (isNaN(photoId)) return;

        const photo = photos.find(p => p.id === photoId);
        if (!photo) return;

        if (lovedPhotos.has(photoId)) {
            lovedPhotos.delete(photoId);
            photo.likes = Math.max(0, photo.likes - 1);
        } else {
            lovedPhotos.add(photoId);
            photo.likes += 1;
        }

        localStorage.setItem('lovedPhotos', JSON.stringify([...lovedPhotos]));

        try {
            const { error } = await supabaseClient
                .from('memories')
                .update({ likes: photo.likes })
                .eq('id', photoId);

            if (error) throw error;

            renderGallery();
            updateStatistics();
            if (currentPhotoId === photoId) updateModalLikes();
            showToast(lovedPhotos.has(photoId) ? '‚ù§Ô∏è Ditambahkan ke favorit' : 'üíî Dihapus dari favorit');
        } catch (err) {
            showToast('Gagal update like');
        }
    }

    function openModal(id) {
        const photoId = parseInt(id);
        if (isNaN(photoId)) return;

        const photo = photos.find(p => p.id === photoId);
        if (!photo) return;

        currentPhotoId = photoId;

        const container = document.getElementById('modalMediaContainer');
        container.innerHTML = photo.type === 'video'
            ? `<video src="${photo.image}" controls autoplay class="w-full h-full max-h-[400px] object-contain"></video>`
            : `<img src="${photo.image}" alt="${photo.title}" class="w-full h-full max-h-[400px] object-contain">`;

        document.getElementById('modalTitle').textContent = photo.title;
        document.getElementById('dateText').textContent = photo.date;
        document.getElementById('modalDescription').textContent = photo.description || 'Tidak ada deskripsi';

        const badge = document.getElementById('modalCategory');
        const catClass = photo.category === 'cb' ? 'cat-cb' : photo.category === 'ld' ? 'cat-ld' : 'cat-nb';
        const catIcon = photo.category === 'cb' ? '<i class="fas fa-users mr-2"></i>' : 
                       photo.category === 'ld' ? '<i class="fas fa-flag mr-2"></i>' : 
                       '<i class="fas fa-landmark mr-2"></i>';
        badge.innerHTML = `${catIcon}${photo.category === 'cb' ? 'Character Building' : photo.category === 'ld' ? 'Leadership Development' : 'National Building'}`;
        badge.className = `px-4 py-2 rounded-full text-sm font-bold ${catClass}`;

        const loveBtn = document.getElementById('modalLoveBtn');
        const loved = lovedPhotos.has(photoId);
        loveBtn.innerHTML = `<i class="${loved ? 'fas' : 'far'} fa-heart"></i>`;
        loveBtn.className = `love-btn text-4xl sm:text-5xl ${loved ? 'loved' : ''}`;

        updateModalLikes();
        document.getElementById('photoModal').classList.remove('hidden');
    }

    function updateModalLikes() {
        const photo = photos.find(p => p.id === currentPhotoId);
        if (photo) document.getElementById('likeCount').textContent = photo.likes || 0;
    }

    function closeModal() {
        document.getElementById('photoModal').classList.add('hidden');
        document.querySelectorAll('#modalMediaContainer video').forEach(v => v.pause());
        currentPhotoId = null;
    }

    function openUploadModal() {
        document.getElementById('uploadModal').classList.remove('hidden');
        document.getElementById('photoDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('mediaPreview').innerHTML = '<p class="text-pink-400 text-center py-12 sm:py-16 text-base sm:text-lg">Preview akan muncul di sini ‚ô°</p>';
    }

    function closeUploadModal() {
        document.getElementById('uploadModal').classList.add('hidden');
        document.getElementById('uploadForm').reset();
        document.getElementById('photoDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('mediaPreview').innerHTML = '<p class="text-pink-400 text-center py-12 sm:py-16 text-base sm:text-lg">Preview akan muncul di sini ‚ô°</p>';
        document.getElementById('uploadProgress').classList.add('hidden');
    }

    function previewMedia(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (file.size > 10 * 1024 * 1024) {
            alert('Ukuran maksimal 10MB');
            event.target.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = e => {
            const tag = file.type.startsWith('video/') 
                ? `<video src="${e.target.result}" controls class="w-full h-full max-h-[300px] object-contain rounded-lg"></video>`
                : `<img src="${e.target.result}" class="w-full h-full max-h-[300px] object-contain rounded-lg">`;
            document.getElementById('mediaPreview').innerHTML = tag;
        };
        reader.readAsDataURL(file);
    }

    async function addPhoto() {
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Mengunggah...';

        try {
            const file = document.getElementById('photoFile').files[0];
            if (!file) throw new Error('Pilih file');

            const url = await uploadToCloudinary(file);

            const title = document.getElementById('photoTitle').value.trim();
            const dateVal = document.getElementById('photoDate').value;
            if (!title || !dateVal) throw new Error('Lengkapi data');

            const dateObj = new Date(dateVal);
            const formattedDate = dateObj.toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });

            const { data, error } = await supabaseClient
                .from('memories')
                .insert({
                    title,
                    date: formattedDate,
                    category: document.getElementById('photoCategory').value,
                    description: document.getElementById('photoDescription').value,
                    media_url: url,
                    media_type: file.type.startsWith('video/') ? 'video' : 'image',
                    likes: 0
                })
                .select();

            if (error) throw error;

            photos.unshift({
                id: data[0].id,
                title: data[0].title,
                date: data[0].date,
                category: data[0].category,
                description: data[0].description || '',
                image: data[0].media_url,
                type: data[0].media_type,
                likes: 0,
                timestamp: data[0].created_at
            });

            renderGallery();
            updateStatistics();
            closeUploadModal();
            showToast('Kenangan berhasil disimpan ‚ù§Ô∏è');
        } catch (err) {
            showToast('Gagal: ' + (err.message || 'Coba lagi'));
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Simpan Kenangan';
        }
    }

    async function deletePhoto() {
        if (!currentPhotoId || !confirm('Yakin ingin menghapus kenangan ini?')) return;

        try {
            const { error } = await supabaseClient
                .from('memories')
                .delete()
                .eq('id', currentPhotoId);

            if (error) throw error;

            photos = photos.filter(p => p.id !== currentPhotoId);
            lovedPhotos.delete(currentPhotoId);
            localStorage.setItem('lovedPhotos', JSON.stringify([...lovedPhotos]));

            closeModal();
            renderGallery();
            updateStatistics();
            showToast('Kenangan telah dihapus');
        } catch (err) {
            showToast('Gagal menghapus');
        }
    }

    document.addEventListener('DOMContentLoaded', initApp);
    document.addEventListener('keydown', e => e.key === 'Escape' && (closeModal(), closeUploadModal()));
</script>
</body>
</html>