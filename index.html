<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeri Kenangan Kita ‚ù§Ô∏è</title>
    <!-- Tailwind CSS dari CDN (alternatif production: https://tailwindcss.com/docs/installation) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Atau gunakan CDN alternatif untuk production: -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"> -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Tambahkan Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fdf2f8 0%, #f0f9ff 100%);
            min-height: 100vh;
        }
        
        .title-font {
            font-family: 'Dancing Script', cursive;
        }
        
        .heartbeat {
            animation: heartbeat 1.5s ease-in-out infinite both;
        }
        
        @keyframes heartbeat {
            0% { transform: scale(1); }
            5% { transform: scale(1.1); }
            10% { transform: scale(1); }
            15% { transform: scale(1.15); }
            20% { transform: scale(1); }
            100% { transform: scale(1); }
        }
        
        .photo-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .photo-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .photo-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #fbcfe8 0%, #c7d2fe 50%, #bae6fd 100%);
            z-index: 10;
        }
        
        .love-btn {
            transition: all 0.3s ease;
        }
        
        .love-btn.loved {
            color: #f472b6;
            transform: scale(1.2);
        }
        
        .love-btn:hover {
            transform: scale(1.1);
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }
        
        .category-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .floating-heart {
            position: absolute;
            font-size: 24px;
            color: #fbcfe8;
            opacity: 0.2;
            animation: float 20s linear infinite;
            z-index: -1;
        }
        
        @keyframes float {
            0% { transform: translateY(100vh) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.2; }
            90% { opacity: 0.2; }
            100% { transform: translateY(-100px) translateX(100px) rotate(360deg); opacity: 0; }
        }
        
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Soft colors untuk kategori */
        .cb-bg { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .ld-bg { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); }
        .nb-bg { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
        
        .cb-text { color: #92400e; }
        .ld-text { color: #065f46; }
        .nb-text { color: #1e40af; }
        
        /* Custom utilities untuk Tailwind */
        .backdrop-blur-sm { backdrop-filter: blur(4px); }
        .backdrop-blur-md { backdrop-filter: blur(8px); }
        .backdrop-blur-lg { backdrop-filter: blur(16px); }
        
        .bg-white\/90 { background-color: rgba(255, 255, 255, 0.9); }
        .bg-white\/95 { background-color: rgba(255, 255, 255, 0.95); }
        .bg-slate-100\/80 { background-color: rgba(241, 245, 249, 0.8); }
        .bg-slate-200\/80 { background-color: rgba(226, 232, 240, 0.8); }
    </style>
</head>
<body class="min-h-screen">
    <!-- Background floating hearts -->
    <div id="floatingHearts"></div>
    
    <header class="sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="text-center bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-lg border border-white/20">
                <h1 class="title-font text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-300 via-purple-300 to-blue-300 mb-4">
                    Kenangan Kita ‚ù§Ô∏è
                </h1>
                <p class="text-slate-500 text-lg mb-6">Simpan momen berharga bersama yang penuh cinta</p>
                
                <div class="flex flex-wrap gap-3 justify-center items-center">
                    <div class="text-sm text-slate-500 bg-slate-100/80 px-4 py-2 rounded-full">
                        <i class="fas fa-heart text-pink-300 mr-2"></i>
                        <span id="totalLikes">0</span> Love ‚Ä¢ 
                        <span id="totalPhotos">0</span> Media
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
        <div class="flex flex-wrap gap-3 justify-center mb-6">
            <button onclick="filterPhotos('all')" class="filter-btn px-6 py-3 rounded-full bg-gradient-to-r from-pink-200 to-rose-200 text-slate-700 font-semibold shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
                <i class="fas fa-star mr-2 text-pink-400"></i>Semua
            </button>
            <button onclick="filterPhotos('cb')" class="filter-btn px-6 py-3 rounded-full bg-white/90 text-slate-600 font-semibold shadow-md hover:shadow-lg transition-all border-2 border-amber-100 hover:border-amber-200">
                <i class="fas fa-user-graduate mr-2 text-amber-400"></i>Character Building
            </button>
            <button onclick="filterPhotos('ld')" class="filter-btn px-6 py-3 rounded-full bg-white/90 text-slate-600 font-semibold shadow-md hover:shadow-lg transition-all border-2 border-emerald-100 hover:border-emerald-200">
                <i class="fas fa-flag mr-2 text-emerald-400"></i>Leadership Development
            </button>
            <button onclick="filterPhotos('nb')" class="filter-btn px-6 py-3 rounded-full bg-white/90 text-slate-600 font-semibold shadow-md hover:shadow-lg transition-all border-2 border-blue-100 hover:border-blue-200">
                <i class="fas fa-landmark mr-2 text-blue-400"></i>National Building
            </button>
        </div>
        
        <div class="flex flex-wrap gap-3 justify-center mb-8">
            <button onclick="filterByType('all')" class="type-filter-btn px-5 py-2 rounded-lg bg-slate-100/80 text-slate-600 font-medium hover:bg-slate-200/80 transition">
                <i class="fas fa-layer-group mr-2"></i>Semua Media
            </button>
            <button onclick="filterByType('image')" class="type-filter-btn px-5 py-2 rounded-lg bg-white/90 text-slate-600 font-medium shadow hover:bg-slate-100/90 transition border border-blue-50">
                <i class="fas fa-camera mr-2 text-blue-400"></i>Foto
            </button>
            <button onclick="filterByType('video')" class="type-filter-btn px-5 py-2 rounded-lg bg-white/90 text-slate-600 font-medium shadow hover:bg-slate-100/90 transition border border-purple-50">
                <i class="fas fa-video mr-2 text-purple-400"></i>Video
            </button>
            <button onclick="sortByLikes()" class="px-5 py-2 rounded-lg bg-gradient-to-r from-rose-200 to-pink-200 text-slate-700 font-medium shadow hover:shadow-lg transition">
                <i class="fas fa-heart mr-2 text-rose-400"></i>Paling Banyak Disukai
            </button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-20">
        <div id="loadingIndicator" class="text-center py-20">
            <div class="heartbeat text-6xl text-pink-300 mb-4">
                ‚ù§Ô∏è
            </div>
            <p class="text-slate-500 text-lg">Memuat kenangan penuh cinta...</p>
        </div>
        
        <div id="gallery" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        
        <div id="emptyState" class="hidden text-center py-20">
            <div class="heartbeat text-8xl text-pink-200 mb-6">
                ‚ù§Ô∏è
            </div>
            <h3 class="title-font text-3xl font-bold text-slate-600 mb-4">Belum Ada Kenangan</h3>
            <p class="text-slate-500 text-lg mb-8">Mulai kenangan pertama dengan menekan tombol hati di bawah!</p>
            <button onclick="openUploadModal()" class="bg-gradient-to-r from-pink-300 to-rose-300 text-slate-700 px-8 py-4 rounded-full text-lg font-semibold shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">
                <i class="fas fa-plus mr-2"></i>Tambah Kenangan Pertama
            </button>
        </div>
    </main>

    <!-- Floating Action Button -->
    <div class="fixed bottom-8 right-8 z-30">
        <button onclick="openUploadModal()" class="heartbeat bg-gradient-to-r from-rose-300 to-pink-300 text-slate-700 p-5 rounded-full shadow-2xl hover:shadow-3xl transition-all hover:scale-110">
            <i class="fas fa-heart text-2xl"></i>
        </button>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onclick="closeModal()">
        <div class="bg-white/95 backdrop-blur-sm rounded-3xl max-w-4xl w-full max-h-[90vh] overflow-auto" onclick="event.stopPropagation()">
            <div class="relative">
                <button onclick="closeModal()" class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm rounded-full p-3 shadow-lg hover:bg-white z-10">
                    <i class="fas fa-times text-slate-600"></i>
                </button>
                <div id="modalMediaContainer" class="relative"></div>
                <div class="p-8">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 id="modalTitle" class="title-font text-3xl font-bold text-slate-700 mb-2"></h3>
                            <p id="modalDate" class="text-slate-500 flex items-center">
                                <i class="far fa-calendar mr-2"></i>
                                <span id="dateText"></span>
                            </p>
                        </div>
                        <button onclick="toggleLove(currentPhotoId)" class="love-btn text-3xl text-slate-300 hover:text-rose-300">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>
                    
                    <div class="flex items-center gap-4 mb-6">
                        <span id="modalCategory" class="px-4 py-2 rounded-full text-sm font-semibold"></span>
                        <span id="modalLikes" class="flex items-center text-rose-400">
                            <i class="fas fa-heart mr-2"></i>
                            <span id="likeCount">0</span> Love
                        </span>
                    </div>
                    
                    <p id="modalDescription" class="text-slate-600 text-lg mb-8 leading-relaxed"></p>
                    
                    <div class="flex gap-3">
                        <button onclick="deletePhoto()" class="bg-rose-100 text-rose-500 px-6 py-3 rounded-lg font-semibold hover:bg-rose-200 transition flex items-center">
                            <i class="fas fa-trash mr-2"></i>Hapus
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onclick="closeUploadModal()">
        <div class="bg-white/95 backdrop-blur-sm rounded-3xl max-w-md w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-8">
                <div class="text-center mb-6">
                    <div class="heartbeat text-4xl text-pink-300 mb-2">
                        ‚ù§Ô∏è
                    </div>
                    <h3 class="title-font text-3xl font-bold text-slate-700">Tambah Kenangan Baru</h3>
                    <p class="text-slate-500">Bagikan momen spesial penuh cinta</p>
                </div>
                
                <form id="uploadForm" class="space-y-6">
                    <div>
                        <label class="block text-slate-600 font-semibold mb-2">
                            <i class="far fa-heart text-pink-300 mr-2"></i>Judul Kenangan
                        </label>
                        <input type="text" id="photoTitle" required 
                               class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-pink-300 focus:border-transparent outline-none transition bg-white/80"
                               placeholder="Judul kenangan spesial...">
                    </div>
                    
                    <div>
                        <label class="block text-slate-600 font-semibold mb-2">
                            <i class="far fa-calendar text-blue-300 mr-2"></i>Tanggal
                        </label>
                        <input type="date" id="photoDate" required 
                               class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-300 focus:border-transparent outline-none transition bg-white/80">
                    </div>
                    
                    <div>
                        <label class="block text-slate-600 font-semibold mb-2">
                            <i class="fas fa-tag text-emerald-300 mr-2"></i>Kategori
                        </label>
                        <select id="photoCategory" 
                                class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-300 focus:border-transparent outline-none transition bg-white/80">
                            <option value="cb">Character Building</option>
                            <option value="ld">Leadership Development</option>
                            <option value="nb">National Building</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-slate-600 font-semibold mb-2">
                            <i class="far fa-comment text-purple-300 mr-2"></i>Deskripsi
                        </label>
                        <textarea id="photoDescription" rows="3" 
                                  class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-300 focus:border-transparent outline-none transition bg-white/80"
                                  placeholder="Ceritakan kenangan indah ini..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-slate-600 font-semibold mb-2">
                            <i class="fas fa-cloud-upload-alt text-amber-300 mr-2"></i>Upload Foto / Video
                        </label>
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:border-pink-300 transition bg-white/80"
                             onclick="document.getElementById('photoFile').click()">
                            <i class="fas fa-file-upload text-3xl text-slate-400 mb-3"></i>
                            <p class="text-slate-500 mb-2">Klik untuk upload</p>
                            <p class="text-sm text-slate-400">Format: JPG, PNG, GIF, MP4, MOV (Max: 10MB)</p>
                        </div>
                        <input type="file" id="photoFile" accept="image/*,video/*" required 
                               class="hidden" onchange="previewMedia(event)">
                        
                        <div id="uploadProgress" class="hidden mt-4">
                            <div class="flex justify-between text-sm text-slate-500 mb-2">
                                <span>Mengunggah...</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-2">
                                <div id="progressBar" class="h-2 rounded-full bg-gradient-to-r from-blue-300 to-purple-300" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div id="mediaPreview" class="mt-4 rounded-xl overflow-hidden border-2 border-slate-200 bg-white/80">
                            <p class="text-slate-400 text-sm p-4 text-center">Preview akan muncul di sini</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" id="submitBtn" 
                                class="flex-1 bg-gradient-to-r from-pink-300 to-rose-300 text-slate-700 py-4 rounded-xl font-semibold hover:shadow-xl transition transform hover:-translate-y-1">
                            <i class="fas fa-heart mr-2"></i>Simpan Kenangan
                        </button>
                        <button type="button" onclick="closeUploadModal()" 
                                class="flex-1 bg-slate-100/80 text-slate-600 py-4 rounded-xl font-semibold hover:bg-slate-200/80 transition">
                            Batal
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="hidden fixed bottom-24 right-8 bg-gradient-to-r from-emerald-200 to-green-200 text-slate-700 px-6 py-3 rounded-xl shadow-2xl z-40 transform transition-all duration-300 translate-x-full">
        <div class="flex items-center gap-3">
            <i class="fas fa-check-circle text-xl"></i>
            <span id="toastMessage">Berhasil!</span>
        </div>
    </div>

    <script>
        // Deklarasi variabel global
        let photos = [];
        let currentFilter = 'all';
        let currentTypeFilter = 'all';
        let currentPhotoId = null;
        let lovedPhotos = new Set();

        // Supabase Configuration
        const supabaseUrl = 'https://cgobihlfddgyhrlfmcew.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnb2JpaGxmZGRneWhybGZtY2V3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU3NjUwOTIsImV4cCI6MjA1MTM0MTA5Mn0.TVhJk4K_c4bZOxnQl6aZqQ4cH8a3Cj-5N7bQJyYJ7gk';
        
        // Inisialisasi Supabase client
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Cloudinary Configuration
        const cloudName = 'dxcconkoi';
        const uploadPreset = 'galerikenangan';
        
        // Fungsi untuk menampilkan toast notifikasi
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'translate-x-full');
            toast.classList.add('translate-x-0');
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // Buat floating hearts background
        function createFloatingHearts() {
            const container = document.getElementById('floatingHearts');
            for (let i = 0; i < 15; i++) {
                const heart = document.createElement('div');
                heart.className = 'floating-heart';
                heart.innerHTML = '‚ù§Ô∏è';
                heart.style.left = `${Math.random() * 100}%`;
                heart.style.animationDelay = `${Math.random() * 20}s`;
                heart.style.fontSize = `${Math.random() * 20 + 16}px`;
                container.appendChild(heart);
            }
        }

        // Fungsi untuk upload ke Cloudinary
        async function uploadToCloudinary(file) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', uploadPreset);
                formData.append('cloud_name', cloudName);
                
                document.getElementById('uploadProgress').classList.remove('hidden');
                
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        document.getElementById('progressBar').style.width = percent + '%';
                        document.getElementById('progressPercent').textContent = percent + '%';
                    }
                });
            
                xhr.addEventListener('load', () => {
                    document.getElementById('uploadProgress').classList.add('hidden');
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        resolve(response.secure_url);
                    } else {
                        reject(new Error('Upload gagal'));
                    }
                });
                
                xhr.addEventListener('error', () => {
                    document.getElementById('uploadProgress').classList.add('hidden');
                    reject(new Error('Network error'));
                });
                
                xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`);
                xhr.send(formData);
            });
        }

        // Fungsi untuk menyimpan data ke Supabase
        async function saveToSupabase() {
            try {
                // Hapus semua data lama
                const { error: deleteError } = await supabase
                    .from('memories')
                    .delete()
                    .neq('id', 0); // Hapus semua data
                
                if (deleteError) throw deleteError;
                
                // Simpan setiap foto ke Supabase
                for (const photo of photos) {
                    const { error } = await supabase
                        .from('memories')
                        .insert({
                            title: photo.title,
                            date: photo.date,
                            category: photo.category,
                            description: photo.description,
                            media_url: photo.cloudinaryUrl,
                            media_type: photo.type,
                            likes: photo.likes || 0,
                            color: photo.color,
                            timestamp: photo.timestamp
                        });
                    
                    if (error) throw error;
                }
                
                // Update statistics
                updateStatistics();
                console.log('Data berhasil disimpan ke Supabase');
                
            } catch (error) {
                console.error('Error saving to Supabase:', error);
                showToast('‚ö†Ô∏è Gagal menyimpan ke database');
            }
        }

        // Fungsi untuk memuat data dari Supabase
        async function loadFromSupabase() {
            try {
                const { data, error } = await supabase
                    .from('memories')
                    .select('*')
                    .order('timestamp', { ascending: false });
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    photos = data.map(item => ({
                        id: item.id,
                        title: item.title,
                        date: item.date,
                        category: item.category,
                        description: item.description,
                        image: item.media_url,
                        cloudinaryUrl: item.media_url,
                        type: item.media_type,
                        color: item.color || 'yellow',
                        likes: item.likes || 0,
                        timestamp: item.timestamp
                    }));
                    
                    return true;
                }
            } catch (error) {
                console.error('Error loading from Supabase:', error);
            }
            return false;
        }

        // Update statistics
        function updateStatistics() {
            const totalLikes = photos.reduce((sum, photo) => sum + (photo.likes || 0), 0);
            const totalPhotos = photos.length;
            
            document.getElementById('totalLikes').textContent = totalLikes;
            document.getElementById('totalPhotos').textContent = totalPhotos;
        }

        // Initialize app
        async function initApp() {
            createFloatingHearts();
            
            const loaded = await loadFromSupabase();
            
            if (loaded && photos.length > 0) {
                photos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                renderGallery();
                updateStatistics();
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('gallery').classList.remove('hidden');
            } else {
                photos = [];
                document.getElementById('loadingIndicator').classList.add('hidden');
                if (photos.length === 0) {
                    document.getElementById('emptyState').classList.remove('hidden');
                }
            }
            
            // Setup event listener untuk form upload
            document.getElementById('submitBtn').addEventListener('click', addPhoto);
        }

        // Render gallery
        function renderGallery() {
            const gallery = document.getElementById('gallery');
            const emptyState = document.getElementById('emptyState');
            
            let filtered = currentFilter === 'all' 
                ? photos 
                : photos.filter(p => p.category === currentFilter);
            
            if (currentTypeFilter !== 'all') {
                filtered = filtered.filter(p => p.type === currentTypeFilter);
            }
            
            if (filtered.length === 0) {
                gallery.innerHTML = '';
                gallery.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            gallery.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            gallery.innerHTML = filtered.map(photo => {
                const isLoved = lovedPhotos.has(photo.id);
                const colorClass = photo.category === 'cb' ? 'cb-bg cb-text' 
                    : photo.category === 'ld' ? 'ld-bg ld-text' 
                    : 'nb-bg nb-text';
                
                const categoryName = {
                    'cb': 'Character Building',
                    'ld': 'Leadership Development',
                    'nb': 'National Building'
                }[photo.category];
                
                const typeIcon = photo.type === 'video' 
                    ? '<i class="fas fa-play-circle"></i>' 
                    : '<i class="fas fa-camera"></i>';
                
                return `
                    <div class="photo-card group cursor-pointer" onclick="openModal('${photo.id}')">
                        <div class="relative overflow-hidden h-64">
                            ${photo.type === 'video' ? `
                                <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent z-10"></div>
                                <video src="${photo.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"></video>
                                <div class="absolute bottom-4 left-4 text-white text-sm z-20 flex items-center">
                                    ${typeIcon} <span class="ml-2">Video</span>
                                </div>
                            ` : `
                                <img src="${photo.image}" alt="${photo.title}" 
                                     class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                                <div class="absolute bottom-4 left-4 text-white text-sm z-20 flex items-center">
                                    ${typeIcon} <span class="ml-2">Foto</span>
                                </div>
                            `}
                            
                            <div class="category-badge ${colorClass} px-4 py-1.5 rounded-full text-sm font-semibold shadow-lg">
                                ${categoryName}
                            </div>
                            
                            <div class="absolute bottom-4 right-4 z-20 flex items-center space-x-2">
                                <button onclick="event.stopPropagation(); toggleLove('${photo.id}')" 
                                        class="love-btn ${isLoved ? 'loved' : ''} text-white text-xl">
                                    <i class="${isLoved ? 'fas' : 'far'} fa-heart"></i>
                                </button>
                                <span class="text-white font-semibold">${photo.likes || 0}</span>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <h3 class="title-font text-2xl font-bold text-slate-700 mb-2">${photo.title}</h3>
                            <p class="text-slate-500 text-sm mb-3 flex items-center">
                                <i class="far fa-calendar mr-2"></i>${photo.date}
                            </p>
                            <p class="text-slate-600 line-clamp-2">${photo.description || 'Tidak ada deskripsi'}</p>
                            <button onclick="event.stopPropagation(); openModal('${photo.id}')" 
                                    class="mt-4 text-blue-400 hover:text-blue-500 font-semibold flex items-center">
                                Lihat Detail <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter functions
        function filterPhotos(category) {
            currentFilter = category;
            renderGallery();
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('from-pink-200', 'to-rose-200', 'text-slate-700');
                btn.classList.add('bg-white/90', 'text-slate-600');
            });
            event.target.classList.remove('bg-white/90', 'text-slate-600');
            event.target.classList.add('from-pink-200', 'to-rose-200', 'text-slate-700');
        }

        function filterByType(type) {
            currentTypeFilter = type;
            renderGallery();
            
            document.querySelectorAll('.type-filter-btn').forEach(btn => {
                btn.classList.remove('bg-slate-200/80');
                btn.classList.add('bg-white/90');
            });
            event.target.classList.remove('bg-white/90');
            event.target.classList.add('bg-slate-200/80');
        }

        function sortByLikes() {
            photos.sort((a, b) => (b.likes || 0) - (a.likes || 0));
            renderGallery();
            showToast('Diurutkan berdasarkan love terbanyak!');
        }

        // Toggle love
        async function toggleLove(photoId) {
            event.stopPropagation();
            const photo = photos.find(p => p.id === photoId);
            if (!photo) return;
            
            if (lovedPhotos.has(photoId)) {
                lovedPhotos.delete(photoId);
                photo.likes = Math.max(0, (photo.likes || 0) - 1);
            } else {
                lovedPhotos.add(photoId);
                photo.likes = (photo.likes || 0) + 1;
            }
            
            // Save to Supabase
            try {
                const { error } = await supabase
                    .from('memories')
                    .update({ likes: photo.likes })
                    .eq('id', photoId);
                
                if (error) throw error;
                
                saveToSupabase();
                renderGallery();
                
                // Update modal if open
                if (currentPhotoId === photoId) {
                    updateModalLikes();
                }
                
                showToast(lovedPhotos.has(photoId) ? '‚ù§Ô∏è Ditambahkan ke favorit!' : 'üíî Dihapus dari favorit');
                
            } catch (error) {
                console.error('Error updating likes:', error);
                showToast('‚ö†Ô∏è Gagal menyimpan perubahan like');
            }
        }

        // Modal functions
        function openModal(id) {
            const photo = photos.find(p => p.id === id);
            if (!photo) return;
            
            currentPhotoId = id;
            
            const mediaContainer = document.getElementById('modalMediaContainer');
            if (photo.type === 'video') {
                mediaContainer.innerHTML = `
                    <div class="relative">
                        <video src="${photo.image}" controls class="w-full h-[400px] object-cover rounded-t-3xl"></video>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent rounded-t-3xl"></div>
                    </div>
                `;
            } else {
                mediaContainer.innerHTML = `
                    <div class="relative">
                        <img src="${photo.image}" alt="${photo.title}" class="w-full h-[400px] object-cover rounded-t-3xl">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent rounded-t-3xl"></div>
                    </div>
                `;
            }
            
            document.getElementById('modalTitle').textContent = photo.title;
            document.getElementById('dateText').textContent = photo.date;
            document.getElementById('modalDescription').textContent = photo.description || 'Tidak ada deskripsi';
            
            const categoryBadge = document.getElementById('modalCategory');
            categoryBadge.textContent = {
                'cb': 'Character Building',
                'ld': 'Leadership Development',
                'nb': 'National Building'
            }[photo.category];
            
            const badgeClass = photo.category === 'cb' ? 'cb-bg cb-text' :
                              photo.category === 'ld' ? 'ld-bg ld-text' :
                              'nb-bg nb-text';
            categoryBadge.className = `px-4 py-2 rounded-full text-sm font-semibold ${badgeClass}`;
            
            // Update love button in modal
            const loveBtn = document.querySelector('#photoModal .love-btn');
            const isLoved = lovedPhotos.has(id);
            loveBtn.innerHTML = `<i class="${isLoved ? 'fas' : 'far'} fa-heart"></i>`;
            loveBtn.className = `love-btn text-3xl ${isLoved ? 'loved text-rose-400' : 'text-slate-300 hover:text-rose-300'}`;
            
            updateModalLikes();
            
            document.getElementById('photoModal').classList.remove('hidden');
        }

        function updateModalLikes() {
            const photo = photos.find(p => p.id === currentPhotoId);
            if (photo) {
                document.getElementById('likeCount').textContent = photo.likes || 0;
            }
        }

        function closeModal() {
            document.getElementById('photoModal').classList.add('hidden');
            const videoElements = document.querySelectorAll('#modalMediaContainer video');
            videoElements.forEach(v => v.pause());
            currentPhotoId = null;
        }

        function openUploadModal() {
            document.getElementById('uploadModal').classList.remove('hidden');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('photoDate').value = today;
            document.getElementById('uploadProgress').classList.add('hidden');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('mediaPreview').innerHTML = '<p class="text-slate-400 text-sm p-4 text-center">Preview akan muncul di sini</p>';
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('uploadForm').reset();
        }

        function previewMedia(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                alert('Ukuran file terlalu besar! Maksimal 10MB');
                event.target.value = '';
                document.getElementById('mediaPreview').innerHTML = '<p class="text-slate-400 text-sm p-4 text-center">Preview akan muncul di sini</p>';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const isVideo = file.type.startsWith('video/');
                if (isVideo) {
                    document.getElementById('mediaPreview').innerHTML = 
                        `<video src="${e.target.result}" controls class="w-full h-48 object-cover"></video>`;
                } else {
                    document.getElementById('mediaPreview').innerHTML = 
                        `<img src="${e.target.result}" class="w-full h-48 object-cover" alt="Preview">`;
                }
            };
            reader.readAsDataURL(file);
        }

        // Add photo
        async function addPhoto(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mengunggah...';
            submitBtn.disabled = true;
            
            try {
                const file = document.getElementById('photoFile').files[0];
                if (!file) {
                    alert('Silakan pilih foto atau video terlebih dahulu');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    return;
                }

                const cloudinaryUrl = await uploadToCloudinary(file);
                
                const colors = ['yellow', 'red', 'blue'];
                const isVideo = file.type.startsWith('video/');
                
                const dateValue = document.getElementById('photoDate').value;
                const dateObj = new Date(dateValue);
                
                const newPhoto = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    title: document.getElementById('photoTitle').value,
                    date: dateObj.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    }),
                    category: document.getElementById('photoCategory').value,
                    description: document.getElementById('photoDescription').value || '',
                    image: cloudinaryUrl,
                    cloudinaryUrl: cloudinaryUrl,
                    type: isVideo ? 'video' : 'image',
                    color: colors[Math.floor(Math.random() * colors.length)],
                    likes: 0,
                    timestamp: Date.now()
                };
                
                photos.unshift(newPhoto);
                
                // Save to Supabase
                await saveToSupabase();
                
                renderGallery();
                closeUploadModal();
                showToast('‚ù§Ô∏è Kenangan berhasil disimpan!');
                
            } catch (error) {
                console.error('Error uploading:', error);
                showToast('‚ùå Gagal mengunggah media. Silakan coba lagi.');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        async function deletePhoto() {
            if (!currentPhotoId) return;
            
            if (confirm('Apakah Anda yakin ingin menghapus kenangan ini?')) {
                try {
                    const photo = photos.find(p => p.id === currentPhotoId);
                    
                    // Hapus dari Supabase
                    const { error } = await supabase
                        .from('memories')
                        .delete()
                        .eq('id', currentPhotoId);
                    
                    if (error) throw error;
                    
                    // Hapus dari array lokal
                    photos = photos.filter(p => p.id !== currentPhotoId);
                    lovedPhotos.delete(currentPhotoId);
                    
                    // Simpan perubahan ke Supabase
                    await saveToSupabase();
                    
                    closeModal();
                    renderGallery();
                    showToast('Kenangan berhasil dihapus');
                    
                } catch (error) {
                    console.error('Error deleting:', error);
                    showToast('‚ùå Gagal menghapus kenangan');
                }
            }
        }

        // Initialize app when page loads
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>